!function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:o})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/ywiki-plugins/dist/production/",n(n.s=29)}({26:function(t,e,n){"use strict";function o(){this._s1=[],this._s2=[]}t.exports=function(e){var n;function r(t,e){var r=new o;function s(e,o,s){if(t){t--;var i=new n(function(t){t(e.apply(o,s))});return i.then(a,a),i}return new n(function(t){r.push(new function(t,e,n,o){this.resolve=t,this.fn=e,this.self=n||null,this.args=o}(t,e,o,s))})}function a(){if(t++,!r.isEmpty()){var e=r.shift();e.resolve(s(e.fn,e.self,e.args))}}if("function"==typeof t){var i=e;e=t,t=i}if("number"!=typeof t)throw new TypeError("Expected throat size to be a number but got "+typeof t);if(void 0!==e&&"function"!=typeof e)throw new TypeError("Expected throat fn to be a function but got "+typeof e);return"function"==typeof e?function(){for(var t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);return s(e,this,t)}:function(t){if("function"!=typeof t)throw new TypeError("Expected throat fn to be a function but got "+typeof t);for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);return s(t,this,e)}}if(1===arguments.length&&"function"==typeof e)return n=e,r;if("function"!=typeof(n=t.exports.Promise))throw new Error("You must provide a Promise polyfill for this library to work in older environments");return r(arguments[0],arguments[1])},"function"==typeof Promise&&(t.exports.Promise=Promise),o.prototype.push=function(t){this._s1.push(t)},o.prototype.shift=function(){var t=this._s2;if(0===t.length){var e=this._s1;if(0===e.length)return;this._s1=t,t=this._s2=e.reverse()}return t.pop()},o.prototype.isEmpty=function(){return!this._s1.length&&!this._s2.length}},29:function(t,e,n){"use strict";n.r(e);const o=n(26)(3),r=n(26)(1);async function s(t,e,n){var o="";n&&(o="&expand="+encodeURIComponent(n));var r="/rest/api/content?type=page&spaceKey="+encodeURIComponent(t)+"&limit=1&title="+encodeURIComponent(e)+o;console.log("Getting page content from "+r);var s=await $.ajax(r);if(console.log("Filtering AJAX response",s),s.results&&s.results.length>0){var a=s.results[0];return console.log("Returning ",a),a}throw"Page Not found: '"+t+":"+e+"'"}async function a(t,e){var n="";e&&(n="?expand="+encodeURIComponent(e));var o="/rest/api/content/"+encodeURIComponent(t)+n;return console.log(o),await $.ajax(o)}async function i(t,e,n){return t.ancestors=[{id:n}],console.log("New Page",t),t.space={key:e},await async function(t){return await r(async()=>await $.ajax({url:"/rest/api/content",type:"POST",contentType:"application/json",data:JSON.stringify(t)}))}(t)}const c="/rest/api/content/";async function u(t,e){let n=await async function(t,e){let n=await $.get(c+`${t}/child/attachment?filename=${e}&expand=version,container`);return n&&n.results&&n.results.length?n.results[0]:null}(e,t.title),s=n?n.id:null;return async function(t,e,n,s){let a=await async function(t){return o(()=>(async function(t){return new Promise((e,n)=>{let o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onerror=n,o.onload=function(t){if(200==this.status){let t=this.response;e(t)}else n(t)},o.send()})})(t))}(t),i=JSON.parse(await async function(t,e,n,o){let s=c;s+=t,s+="/child/attachment",o&&(s+="/"+o+"/data");let a=new FormData;return a.append("file",e,n),a.append("minorEdit","true"),r(()=>(async function(t,e){return new Promise((n,o)=>{var r=new XMLHttpRequest;r.open("POST",t,!0),r.onerror=o,r.setRequestHeader("X-Atlassian-Token","nocheck"),r.onload=function(e){200==this.status?n(this.response):o(`Could not POST to ${t}: ${this.status} ${this.statusText}, details: ${this.responseText}`)},r.send(e)})})(s,a))}(e,a,n,s));i.results&&i.results instanceof Array&&(i=i.results[0]);i.space||(i.space={key:i._expandable.space.replace(/.*\//,"")});return i}(t._links.download,e,t.title,s)}const l="/rest/api/content/";async function p(t,e){let n=l+`${t}/property/${e}`;return $.get(n)}async function f(t,e){let n=l+`${t}/property`;return $.ajax({url:n,contentType:"application/json;charset=UTF-8",type:"POST",data:JSON.stringify(e)})}async function y(t,e){let n=l+`${t}/property/${e.key}`;return $.ajax({url:n,contentType:"application/json;charset=UTF-8",type:"PUT",data:JSON.stringify(e)})}async function h(t,e,n){let o;try{(o=await p(t,e)).version.number++}catch(t){o={id:null,key:e,version:{minorEdit:!0,number:null},value:{}}}await n(o),o.id?y(t,o):f(t,o)}async function d(t,e,n,o){let r,c=await a(t,"version,space,body.storage,metadata.labels,children.attachment.version,children.attachment.space");try{r=await s(e,c.title,"version")}catch(t){r=await i(c,e,n)}if(o){let t=await async function t(e,n){const o=[];for(let t of e.results){let e=await u(t,n);await g(t,e,t.space.key,e.space.key),o.push(e)}if(e._links.next){console.log("More than 25 attachments, loading next page");let r=await t(await $.get(e._links.next+"&expand=space,version"),n);return[].concat(o,r)}return o}(c.children.attachment,r.id);console.log(`${t.length} attachments synced for ${c.title}`)}return await g(c,r,c.space.key,e),r}async function g(t,e,n,o){let r=new Date;await h(t.id,"ysync",function(n){n.value.syncTargets&&console.log("Previous value on source item: syncTargets: ",n.value.syncTargets),n.value.syncTargets=n.value.syncTargets||{},n.value.syncTargets[o]={targetContentId:e.id,targetVersion:e.version.number,sourceVersion:t.version.number,syncTime:r}}),await h(e.id,"ysync",function(o){o.value.syncSources&&console.log("Previous value on target item: syncSources: ",o.value.syncSources),o.value.syncSources=o.value.syncSources||{},o.value.syncSources[n]={sourceContentId:t.id,targetVersion:e.version.number,sourceVersion:t.version.number,syncTime:r}})}console.log("jquery binding"),$("#copyBtn").click(async()=>{try{let t=$("#sourceSpaceKey").val(),e=$("#targetSpaceKey").val(),n=$("#targetParentPage").val(),o=$("#sourcePageTitle").val();w(),w(`Syncing ${o} to ${e}...`);let r=await s(t,o),a=await s(e,n),i=await d(r.id,e,a.id,!0);w("Done"),$("#resultPage").html(`<a href="https://wiki.hybris.com/pages/viewpage.action?pageId=${i.id}">${i.title}</a>`)}catch(t){w(t)}});const v=$("#output");function w(t){void 0===t||null===t?v.text(""):v.text(v.text()+t+"\n")}}});
//# sourceMappingURL=space-sync-bundle.js.map