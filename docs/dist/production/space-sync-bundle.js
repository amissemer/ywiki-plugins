!function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/ywiki-plugins/dist/production/",n(n.s=29)}({2:function(t,e,n){"use strict";n.d(e,"c",function(){return r}),n.d(e,"d",function(){return o}),n.d(e,"f",function(){return a}),n.d(e,"l",function(){return i}),n.d(e,"m",function(){return s}),n.d(e,"g",function(){return c}),n.d(e,"k",function(){return u}),n.d(e,"i",function(){return l}),n.d(e,"h",function(){return p}),n.d(e,"e",function(){return f}),n.d(e,"a",function(){return y}),n.d(e,"b",function(){return d}),n.d(e,"n",function(){return h}),n.d(e,"j",function(){return g});const r="key,summary,created,priority,status",o=10,a="CI",i="customfield_10032",s="wiki.hybris.com",c=50,u=500,l="ywiki-plugins.",p="preferred.region",f="Project Documentation",y="Continuous Improvement - The Golden Button",d=".CI New Project Documentation Template",h="https://bzycrip1eh.execute-api.eu-central-1.amazonaws.com/dev/page/transform",g="ysync"},26:function(t,e,n){"use strict";function r(){this._s1=[],this._s2=[]}t.exports=function(e){var n;function o(t,e){var o=new r;function a(e,r,a){if(t){t--;var s=new n(function(t){t(e.apply(r,a))});return s.then(i,i),s}return new n(function(t){o.push(new function(t,e,n,r){this.resolve=t,this.fn=e,this.self=n||null,this.args=r}(t,e,r,a))})}function i(){if(t++,!o.isEmpty()){var e=o.shift();e.resolve(a(e.fn,e.self,e.args))}}if("function"==typeof t){var s=e;e=t,t=s}if("number"!=typeof t)throw new TypeError("Expected throat size to be a number but got "+typeof t);if(void 0!==e&&"function"!=typeof e)throw new TypeError("Expected throat fn to be a function but got "+typeof e);return"function"==typeof e?function(){for(var t=[],n=0;n<arguments.length;n++)t.push(arguments[n]);return a(e,this,t)}:function(t){if("function"!=typeof t)throw new TypeError("Expected throat fn to be a function but got "+typeof t);for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);return a(t,this,e)}}if(1===arguments.length&&"function"==typeof e)return n=e,o;if("function"!=typeof(n=t.exports.Promise))throw new Error("You must provide a Promise polyfill for this library to work in older environments");return o(arguments[0],arguments[1])},"function"==typeof Promise&&(t.exports.Promise=Promise),r.prototype.push=function(t){this._s1.push(t)},r.prototype.shift=function(){var t=this._s2;if(0===t.length){var e=this._s1;if(0===e.length)return;this._s1=t,t=this._s2=e.reverse()}return t.pop()},r.prototype.isEmpty=function(){return!this._s1.length&&!this._s2.length}},29:function(t,e,n){"use strict";n.r(e);const r=n(26)(3),o=n(26)(1);async function a(t,e,n){var r="";n&&(r="&expand="+encodeURIComponent(n));var o="/rest/api/content?type=page&spaceKey="+encodeURIComponent(t)+"&limit=1&title="+encodeURIComponent(e)+r;console.log("Getting page content from "+o);var a=await $.ajax(o);if(console.log("Filtering AJAX response",a),a.results&&a.results.length>0){var i=a.results[0];return console.log("Returning ",i),i}throw"Page Not found: '"+t+":"+e+"'"}async function i(t,e){var n="";e&&(n="?expand="+encodeURIComponent(e));var r="/rest/api/content/"+encodeURIComponent(t)+n;return console.log(r),await $.ajax(r)}async function s(t,e,n){return t.ancestors=[{id:n}],console.log("New Page",t),t.space={key:e},await async function(t){return await o(async()=>await $.ajax({url:"/rest/api/content",type:"POST",contentType:"application/json",data:JSON.stringify(t)}))}(t)}const c="/rest/api/content/";async function u(t,e,n){let a=await async function(t,e){let n=await $.get(c+`${t}/child/attachment?filename=${e}&expand=space,version,container`);return n&&n.results&&n.results.length?n.results[0]:null}(e,t.title),i=a?a.id:null;if(n&&null!=i&&(i!==n.targetContentId||a.version.number!==n.targetVersion))throw`Attachment ${i} was modified on target, should we overwrite?`;return n&&null!=i&&t.version.number===n.sourceVersion?(console.log(`attachment ${i} was already up-to-date, synced with source version ${t.version.number}`),a):async function(t,e,n,a){let i=await async function(t){return r(()=>(async function(t){return new Promise((e,n)=>{let r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="blob",r.onerror=n,r.onload=function(t){if(200==this.status){let t=this.response;e(t)}else n(t)},r.send()})})(t))}(t),s=JSON.parse(await async function(t,e,n,r){let a=c;a+=t,a+="/child/attachment",r&&(a+="/"+r+"/data");let i=new FormData;return i.append("file",e,n),i.append("minorEdit","true"),o(()=>(async function(t,e){return new Promise((n,r)=>{var o=new XMLHttpRequest;o.open("POST",t,!0),o.onerror=r,o.setRequestHeader("X-Atlassian-Token","nocheck"),o.onload=function(e){200==this.status?n(this.response):r(`Could not POST to ${t}: ${this.status} ${this.statusText}, details: ${this.responseText}`)},o.send(e)})})(a,i))}(e,i,n,a));s.results&&s.results instanceof Array&&(s=s.results[0]);s.space||(s.space={key:s._expandable.space.replace(/.*\//,"")});return s}(t._links.download,e,t.title,i)}const l="/rest/api/content/";async function p(t,e){let n=l+`${t}/property/${e}`;return $.get(n)}async function f(t,e){let n=l+`${t}/property`;return $.ajax({url:n,contentType:"application/json;charset=UTF-8",type:"POST",data:JSON.stringify(e)})}async function y(t,e){let n=l+`${t}/property/${e.key}`;return $.ajax({url:n,contentType:"application/json;charset=UTF-8",type:"PUT",data:JSON.stringify(e)})}async function d(t,e){try{return(await p(t,e)).value}catch(t){return null}}async function h(t,e,n){let r;try{(r=await p(t,e)).version.number++}catch(t){r={id:null,key:e,version:{minorEdit:!0,number:null},value:{}}}await n(r.value),r.id?y(t,r):f(t,r)}var g=n(2);async function w(t,e,n,r){let o,c=await i(t,"version,space,body.storage,metadata.labels,children.attachment.version,children.attachment.space"),l=await d(t,g.j);if(l&&l.syncTargets&&l.syncTargets[e]){let t=l.syncTargets[e];try{o=await i(t.targetContentId,"version,metadata.labels"),await m(c,o,t)}catch(t){}}if(!o)try{o=await a(e,c.title,"version,metadata.labels"),await m(c,o)}catch(t){o=await s(c,e,n)}if(await v(c,o,c.space.key,e),r){let t=await async function t(e,n,r){const o=[];for(let t of e.results){let e=await d(t.id,g.j),a=null;e&&e.syncTargets&&e.syncTargets[r]&&(a=e.syncTargets[r]);let i=await u(t,n,a);await v(t,i,t.space.key,i.space.key),o.push(i)}if(e._links.next){console.log("More than 25 attachments, loading next page");let a=await t(await $.get(e._links.next+"&expand=space,version"),n,r);return[].concat(o,a)}return o}(c.children.attachment,o.id,e);console.log(`${t.length} attachments synced for ${c.title}`)}return o}async function m(t,e,n){if(n&&e.version.number!==n.targetVersion)throw`targetPage was modified after sync, should we overwrite? ${e.title}`;n&&t.version.number===n.sourceVersion?console.log(`page ${e.title} was already up-to-date, synced with source version ${t.version.number}`):(e.version.number++,e.body=e.body||{},e.body.storage=t.body.storage,e.title=t.title,e.metadata.labels=t.metadata.labels,await async function(t){return await o(async()=>await $.ajax({url:"/rest/api/content/"+encodeURIComponent(t.id),type:"PUT",contentType:"application/json",data:JSON.stringify(t)}))}(e))}async function v(t,e,n,r){let o=new Date,a={sourceContentId:t.id,targetContentId:e.id,sourceVersion:t.version.number,targetVersion:e.version.number,syncTime:o};await h(t.id,g.j,function(t){t.syncTargets?console.log("Previous value on source item: syncTargets: ",t.syncTargets):t.syncTargets={},t.syncTargets[r]=a}),await h(e.id,g.j,function(t){t.syncSources?console.log("Previous value on target item: syncSources: ",t.syncSources):t.syncSources={},t.syncSources[n]=a})}console.log("jquery binding"),$("#copyBtn").click(async()=>{try{let t=$("#sourceSpaceKey").val(),e=$("#targetSpaceKey").val(),n=$("#targetParentPage").val(),r=$("#sourcePageTitle").val();T(),T(`Syncing ${r} to ${e}...`);let o=await a(t,r),i=await a(e,n),s=await w(o.id,e,i.id,!0);T("Done"),$("#resultPage").html(`<a href="https://wiki.hybris.com/pages/viewpage.action?pageId=${s.id}">${s.title}</a>`)}catch(t){T(t)}});const b=$("#output");function T(t){void 0===t||null===t?b.text(""):b.text(b.text()+t+"\n")}}});
//# sourceMappingURL=space-sync-bundle.js.map